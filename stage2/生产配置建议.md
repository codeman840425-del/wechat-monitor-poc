# 微信消息监控服务 - 生产环境配置建议

## 推荐配置参数

### 1. 监控间隔 (monitor.interval)
**推荐值：5-10秒**

- **5秒**：实时性高，但CPU占用较高
- **10秒**：平衡性能和实时性（推荐）
- **30秒**：适合非关键业务场景

```yaml
monitor:
  interval: 10
```

### 2. 关键字列表 (keywords.list)
**推荐关键字组合：**

```yaml
keywords:
  list:
    # 交易类
    - "付款"
    - "支付"
    - "转账"
    - "收款"
    - "退款"
    - "退钱"
    - "打款"
    - "汇款"
    
    # 订单类
    - "订单"
    - "下单"
    - "购买"
    - "采购"
    - "发货"
    - "物流"
    - "快递"
    - "签收"
    
    # 投诉类
    - "投诉"
    - "举报"
    - "问题"
    - "异常"
    - "纠纷"
    - "索赔"
    
    # 价格类
    - "价格"
    - "报价"
    - "费用"
    - "金额"
    - "优惠"
    - "折扣"
    
    # 其他业务关键词
    - "合同"
    - "发票"
    - "售后"
    - "客服"
    - "紧急"
    - "重要"
```

### 3. 匹配模式 (keywords.match_mode)
**推荐："contain"（包含匹配）**

- **contain**：消息包含关键字即可（最常用）
- **fuzzy**：模糊匹配（处理OCR误差，推荐用于中文）
- **exact**：精确匹配（不推荐，OCR误差会导致漏检）

```yaml
keywords:
  match_mode: "contain"
  fuzzy_threshold: 0.7  # 模糊匹配阈值（仅fuzzy模式有效）
```

### 4. 聊天区域裁剪 (ocr.chat_area)
**推荐值（微信PC版）：**

```yaml
ocr:
  chat_area:
    left_crop: 0.28    # 左侧裁剪28%，排除联系人列表
    top_crop: 0.09     # 顶部裁剪9%，排除标题栏
    right_crop: 0.03   # 右侧裁剪3%，排除滚动条
    bottom_crop: 0.14  # 底部裁剪14%，排除输入框
```

**调整建议：**
- 如果截图包含联系人列表 → 增大 `left_crop`
- 如果截图包含输入框 → 增大 `bottom_crop`
- 查看 `debug_chat_area_*.png` 调整参数

### 5. OCR参数 (ocr.lang)
**推荐："chi_sim+eng"**

```yaml
ocr:
  lang: "chi_sim+eng"
  config: "--oem 3 --psm 6"
```

- **chi_sim**：简体中文（必须）
- **chi_sim+eng**：中文+英文（推荐）
- **chi_sim+eng+chi_tra**：中文+英文+繁体（如果需要）

### 6. 日志级别 (logging.level)
**生产环境推荐："INFO"**

```yaml
logging:
  level: "INFO"    # 生产环境
  # level: "DEBUG"  # 调试时使用
```

### 7. 数据保留策略

```yaml
database:
  data_retention_days: 90    # 保留90天
  
monitor:
  screenshot:
    retention_days: 30       # 截图保留30天
```

## 完整生产配置示例

```yaml
# ==================== 监控配置 ====================
monitor:
  interval: 10
  target_window_title: ""  # 留空则手动选择
  
  screenshot:
    save_screenshots: true
    save_directory: "./screenshots"
    retention_days: 30

# ==================== 关键字配置 ====================
keywords:
  list:
    - "付款"
    - "支付"
    - "转账"
    - "退款"
    - "订单"
    - "发货"
    - "投诉"
    - "价格"
    - "合同"
    - "发票"
  
  match_mode: "contain"
  case_sensitive: false
  fuzzy_threshold: 0.7

# ==================== 数据库配置 ====================
database:
  db_path: "./wechat_monitor.db"
  data_retention_days: 90
  enable_vacuum: true

# ==================== 日志配置 ====================
logging:
  level: "INFO"
  log_file: "./monitor.log"
  console_output: true
  max_size_mb: 50
  backup_count: 5

# ==================== OCR配置 ====================
ocr:
  tesseract_cmd: ""
  lang: "chi_sim+eng"
  config: "--oem 3 --psm 6"
  
  chat_area:
    left_crop: 0.28
    top_crop: 0.09
    right_crop: 0.03
    bottom_crop: 0.14

# ==================== 高级配置 ====================
advanced:
  deduplication:
    enabled: true
    time_window: 120
    similarity_threshold: 0.85
  
  performance:
    screenshot_quality: 85
    ocr_timeout: 15
    max_messages_per_scan: 100
```

## 部署建议

### 1. 硬件要求
- **CPU**：双核以上（OCR较耗CPU）
- **内存**：4GB以上
- **磁盘**：根据数据保留策略，建议预留10GB+

### 2. 系统设置
- **分辨率**：推荐1920x1080或更高
- **缩放比例**：100%（避免DPI缩放导致截图偏移）
- **电源管理**：禁用自动休眠

### 3. 微信窗口设置
- 将微信窗口固定在屏幕右侧
- 调整窗口宽度为屏幕的40-50%
- 确保聊天区域完整可见
- **不要最小化或遮挡窗口**

### 4. 监控和维护
- 定期检查 `monitor.log` 是否有错误
- 每周查看数据库大小，必要时清理
- 每月检查截图目录，删除过期文件

### 5. 备份策略
- 定期备份 `wechat_monitor.db` 数据库
- 重要截图单独备份
- 配置文件版本控制

## 故障排查

### OCR识别率低
1. 检查 `debug_ocr_*.png` 图像质量
2. 调整 `chat_area` 裁剪参数
3. 确保Tesseract中文语言包已安装
4. 尝试调整对比度参数

### 匹配不到关键字
1. 检查 `debug_chat_area_*.png` 是否包含消息
2. 查看日志中的OCR文本预览
3. 尝试使用 `fuzzy` 匹配模式
4. 添加更多关键字变体

### 数据库写入失败
1. 检查磁盘空间
2. 检查文件权限
3. 查看 `monitor.log` 错误日志

## 性能优化

### 降低CPU占用
```yaml
monitor:
  interval: 30  # 增大扫描间隔

advanced:
  performance:
    max_messages_per_scan: 50  # 限制单次处理消息数
```

### 降低磁盘占用
```yaml
monitor:
  screenshot:
    save_screenshots: false  # 不保存截图（仅保留数据库记录）

database:
  data_retention_days: 30  # 减少数据保留天数
```

## 安全建议

1. **数据加密**：敏感数据库考虑加密存储
2. **访问控制**：限制对监控服务器的物理和远程访问
3. **日志审计**：定期审计日志文件
4. **合规使用**：确保符合相关法律法规和公司政策

---

**版本：** 阶段2 - 生产优化版  
**更新日期：** 2025年
